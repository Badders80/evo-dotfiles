#!/bin/bash
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Evo Doctor - Sanity Check for Evolution Stables
# Run weekly or when things feel "off"
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

EVO_ROOT="/home/evo"

# Colors (define FIRST)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

ISSUES=0
WARNINGS=0

echo "๐ฉบ Evo Doctor - Sanity Check"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 0: Universal AI Tool DNA Integration (Critical!)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${BLUE}๐ง Checking Universal AI Tool DNA Integration${NC}"

# Check kimic
if command -v kimic &>/dev/null; then
    KIMIC_PATH=$(command -v kimic)
    if [[ "$KIMIC_PATH" == */.local/bin/kimic ]]; then
        echo -e "  ${GREEN}โ${NC} kimic installed ($KIMIC_PATH)"
    else
        echo -e "  ${GREEN}โ${NC} kimic available ($KIMIC_PATH)"
    fi
else
    echo -e "  ${RED}โ${NC} kimic NOT FOUND"
    echo -e "  ${YELLOW}โ${NC}  Install: cp _scripts/kimic.sh ~/.local/bin/kimic && chmod +x ~/.local/bin/kimic"
    ((WARNINGS++))
fi

# Check claudec
if command -v claudec &>/dev/null; then
    echo -e "  ${GREEN}โ${NC} claudec installed"
else
    echo -e "  ${YELLOW}โ${NC}  claudec not installed (optional - for Claude CLI)"
fi

# Check aidere
if command -v aidere &>/dev/null; then
    echo -e "  ${GREEN}โ${NC} aidere installed"
else
    echo -e "  ${YELLOW}โ${NC}  aidere not installed (optional - for Aider)"
fi

# Check dna-context
if command -v dna-context &>/dev/null; then
    echo -e "  ${GREEN}โ${NC} dna-context installed"
else
    echo -e "  ${RED}โ${NC} dna-context NOT FOUND"
    echo -e "  ${YELLOW}โ${NC}  Install: cp _scripts/dna-context.sh ~/.local/bin/dna-context && chmod +x ~/.local/bin/dna-context"
    ((WARNINGS++))
fi

# Check VS Code Copilot instructions
if [[ -f "$EVO_ROOT/.github/copilot-instructions.md" ]]; then
    echo -e "  ${GREEN}โ${NC} GitHub Copilot instructions configured"
else
    echo -e "  ${YELLOW}โ${NC}  .github/copilot-instructions.md not found (optional - for VS Code)"
fi

# Initialize counters if not already set
ISSUES=${ISSUES:-0}
WARNINGS=${WARNINGS:-0}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 1: DNA Exists (Source of Truth)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${BLUE}๐ Checking DNA (Source of Truth)${NC}"

if [[ -d "$EVO_ROOT/00_DNA" ]]; then
    echo -e "${GREEN}โ${NC} DNA directory exists"
    
    # Check key files
    KEY_FILES=("๐ Home.md" "๐๏ธ Build Rules.md" "AGENTS.core.md" "๐ Secrets Guide.md" "๐ง AI_CONTEXT.md")
    for file in "${KEY_FILES[@]}"; do
        if [[ -f "$EVO_ROOT/00_DNA/$file" ]]; then
            echo -e "  ${GREEN}โ${NC} $file"
        else
            echo -e "  ${YELLOW}โ${NC} $file missing"
            ((WARNINGS++))
        fi
    done
else
    echo -e "${RED}โ${NC} DNA directory MISSING - This is critical!"
    ((ISSUES++))
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 2: Vault Health (One Point for Keys)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${BLUE}๐ Checking Vault (One Point for Keys)${NC}"

if [[ -f "$EVO_ROOT/.env" ]]; then
    perms=$(stat -c "%a" "$EVO_ROOT/.env")
    if [[ "$perms" == "600" ]]; then
        echo -e "${GREEN}โ${NC} Vault exists with secure permissions"
    else
        echo -e "${YELLOW}โ${NC} Vault permissions: $perms (should be 600)"
        ((WARNINGS++))
    fi
else
    echo -e "${RED}โ${NC} Master vault missing at /evo/.env"
    ((ISSUES++))
fi

# Check project symlinks
PROJECT_COUNT=0
LINKED_COUNT=0
for proj in "$EVO_ROOT"/projects/Evolution_*/; do
    if [[ -d "$proj" ]]; then
        ((PROJECT_COUNT++))
        if [[ -L "$proj/.env" ]]; then
            ((LINKED_COUNT++))
        fi
    fi
done

if [[ $LINKED_COUNT -eq $PROJECT_COUNT ]]; then
    echo -e "${GREEN}โ${NC} All $PROJECT_COUNT projects linked to vault"
else
    echo -e "${YELLOW}โ${NC} $LINKED_COUNT/$PROJECT_COUNT projects linked to vault"
    ((WARNINGS++))
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 3: Project Structure (Layer Separation)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${BLUE}๐ Checking Project Structure${NC}"

# Check for projects directly in root (should be in projects/)
ROOT_FOLDERS=$(find "$EVO_ROOT" -maxdepth 1 -type d -name "Evolution_*" 2>/dev/null | wc -l)
if [[ $ROOT_FOLDERS -eq 0 ]]; then
    echo -e "${GREEN}โ${NC} No stray Evolution_* folders in root"
else
    echo -e "${YELLOW}โ${NC} Found $ROOT_FOLDERS Evolution_* folders in root (should be in projects/)"
    find "$EVO_ROOT" -maxdepth 1 -type d -name "Evolution_*" | sed 's/^/    /'
    ((WARNINGS++))
fi

# Check layer separation
if [[ -d "$EVO_ROOT/projects/Infrastructure" ]]; then
    echo -e "${GREEN}โ${NC} Infrastructure layer properly separated"
fi

if [[ -d "$EVO_ROOT/projects/External" ]]; then
    echo -e "${GREEN}โ${NC} External dependencies properly separated"
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 4: Documentation Currency
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${BLUE}๐ Checking Documentation${NC}"

if [[ -f "$EVO_ROOT/FINAL_STRUCTURE.md" ]]; then
    echo -e "${GREEN}โ${NC} FINAL_STRUCTURE.md exists"
else
    echo -e "${YELLOW}โ${NC} FINAL_STRUCTURE.md missing"
    ((WARNINGS++))
fi

if [[ -f "$EVO_ROOT/PROJECTS_INDEX.md" ]]; then
    echo -e "${GREEN}โ${NC} PROJECTS_INDEX.md exists"
else
    echo -e "${YELLOW}โ${NC} PROJECTS_INDEX.md missing"
    ((WARNINGS++))
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CHECK 5: Git Hygiene
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${BLUE}โก Checking Git Hygiene${NC}"

# Check for .env files that might be committed
if [[ -d "$EVO_ROOT/00_DNA/.git" ]]; then
    cd "$EVO_ROOT/00_DNA"
    TRACKED_ENV=$(git ls-files | grep -E "\.env$" | head -5)
    if [[ -n "$TRACKED_ENV" ]]; then
        echo -e "${RED}โ${NC} .env files tracked in DNA git:"
        echo "$TRACKED_ENV" | sed 's/^/    /'
        ((ISSUES++))
    else
        echo -e "${GREEN}โ${NC} No .env files tracked in DNA"
    fi
fi

# Check .gitignore exists in DNA
if [[ -f "$EVO_ROOT/00_DNA/.gitignore" ]]; then
    if grep -q "\.env" "$EVO_ROOT/00_DNA/.gitignore"; then
        echo -e "${GREEN}โ${NC} .env in DNA .gitignore"
    else
        echo -e "${YELLOW}โ${NC} .env not in DNA .gitignore"
        ((WARNINGS++))
    fi
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SUMMARY
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ Summary"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if [[ $ISSUES -eq 0 && $WARNINGS -eq 0 ]]; then
    echo -e "${GREEN}โ All checks passed! Evo is healthy.${NC}"
    echo ""
    echo "Remember:"
    echo "  โข DNA is the source of truth"
    echo "  โข One vault (/evo/.env) for all keys"
    echo "  โข Infrastructure โ Intelligence โ Content"
    exit 0
elif [[ $ISSUES -eq 0 ]]; then
    echo -e "${YELLOW}โ $WARNINGS warning(s) found${NC}"
    echo "These are suggestions, not critical issues."
    echo "Review above and fix if needed."
    exit 0
else
    echo -e "${RED}โ $ISSUES issue(s) and $WARNINGS warning(s) found${NC}"
    echo ""
    echo "Critical issues should be fixed:"
    echo "  1. Check vault health: ./vault.sh check"
    echo "  2. Review DNA structure"
    echo "  3. Check project symlinks"
    exit 1
fi
